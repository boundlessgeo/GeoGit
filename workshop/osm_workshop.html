<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, maximum-scale=1">
  
  <title>Working with OSM data in GeoGig &mdash; GeoGig 1.0 Workshop</title>
  <link rel="stylesheet" href="_static/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="_static/print.css" type="text/css" media="print" /> 
  <!--[if IE]>
  <link rel="stylesheet" href="_static/blueprint/ie.css" type="text/css" media="screen, projection" />
  <![endif]-->
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/offcanvas.css" type="text/css" />
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html'
    };
  </script>
  <link rel="shortcut icon" href="_static/favicon.ico"/>
      <link rel="top" title="GeoGig 1.0 Workshop" href="index.html" />
</head>
<body class="osm_workshop">
    <div id="blacktop"></div>
    <header id="masthead">
      <div class="navbar">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://geogig.org"><h1>GeoGig</h1></a>
          </div>
          <div class="navbar-collapse collapse navbar-right">
            <ul class="nav navbar-nav">
              <li><a href="http://geogig.org/#install">Get Started</a></li>
              <li><a href="http://geogig.org/docs/index.html">Documentation</a></li>
              <li><a href="https://github.com/locationtech/geogig">On Github</a></li>
            </ul>
          </div><!--/.navbar-collapse -->
        </div>
      </div>
    </header>

    <section class="subheading hidden-xs">
      <div class="container">
        <div class="row">
          <div class="col-md-8">
            <p class="byline">A Tool for Geospatial Data Management</p>
          </div>
        </div>
      </div>
    </section>
    <a name="top"></a>

 <div id="main">
    <div class="wrap selfclear">
      <div id="content">
      <div class="container">
        <div class="row row-offcanvas row-offcanvas-right">
          <div class="col-md-8"> 
            <div class="row pull-right">
             <div class="visible-sm visible-xs" id="menu-btn">
                <button class="btn btn-blue btn-sm"type="button" data-toggle="offcanvas">
                  <span class="btn-text active">Menu &rarr;</span>
                  <span class="btn-back">&larr; Back</span>
                </button>
              </div>
            </div>
<ul id="breadcrumbs">
  
  <li><a href="index.html">GeoGig 1.0 Workshop</a> &raquo;</li>
  <li>Working with OSM data in GeoGig</li>
</ul>
<ul id="relatedlinks" class="selfclear">
  <li class="first">
    <a href="genindex.html" title="General Index"
       accesskey="I">index</a></li>
</ul>
        
  <div class="section" id="working-with-osm-data-in-geogig">
<h1>Working with OSM data in GeoGig<a class="headerlink" href="#working-with-osm-data-in-geogig" title="Permalink to this headline">¶</a></h1>
<p>GeoGig includes a set of specific commands to work with OpenStreetMap data. This allows to set up a repository with OSM data and go through a complete workflow of editing and updating it, and eventually preparing the necessary files to contribute changes back to the central OSM planet. This tutorial describes one of such workflows.</p>
<p>The basic OSM-GeoGig workflow follows the scheme summarized below:</p>
<ul class="simple">
<li>Import a set of OSM data from a PBF or XML, add and commit to the node &amp; way trees.</li>
<li>Map that data to a set of GeoGig trees using a mapping specification file</li>
<li>Export those mapped trees to a database or other datastore</li>
<li>Modify the data in the external database with various tools</li>
<li>Import the modified data back into the mapped trees using a GeoGig import</li>
<li>Unmap the changes back to the canonical node &amp; way trees</li>
<li>Create an OSM Changeset based on those changes</li>
<li>Push that changeset to the global OSM API Servers</li>
</ul>
<div class="section" id="setting-up-the-osm-base">
<h2>Setting up the OSM base.<a class="headerlink" href="#setting-up-the-osm-base" title="Permalink to this headline">¶</a></h2>
<p>The first thing to do is to import OSM data into a GeoGig repository, so we can later work with it.</p>
<p>Create a folder for your repository, open a terminal in it and create the repo typing</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig init
</pre></div>
</div>
<p>The easiest way of adding data to your repository is using a file in one of the OSM formats, whether an XML file or a compressed pbf file. Both of them are supported by GeoGig. This will not give you the full history of the repository, but just a single snapshot corresponding to a given time. This is what most users need to perform OSM work.</p>
<p>In the workshop dataset you will find a file named andorra.pbf with an extract of the OSM planet. Import it using the following command</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig osm import andorra.pbf
</pre></div>
</div>
<p>The aove command assumes that the file to import is in the repository folder. Adjust the path accordingly if you have it somewhere else.</p>
<p>You will see something like this:</p>
<div class="highlight-python"><div class="highlight"><pre>Importing into GeoGig repo...
87.120
87.484 entities processed in 7,498 s

Building trees for [node, way]

Trees built in 1,931 s
0%
Processed entities: 87.484.
 Nodes: 83.881.
 Ways: 3.494
</pre></div>
</div>
<p>Two new trees should have been created with your trees and nodes, and you can check that by running:</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig ls
Root tree/
node/
way/
</pre></div>
</div>
<p>The imported features are in the working tree. To create a new snapshot in the repository, you have to add and commit it.</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig add
Counting unstaged elements...87377
Staging changes...
100%
87375 features and 2 trees staged for commit
0 features and 0 trees not staged for commit

$ geogig commit -m &quot;First import of OSM data&quot;
100%
[fb89273215cd0f2a92a22e0120a1bd1a19620e51] First import of OSM data
Committed, counting objects...87375 features added, 0 changed, 0 deleted.
</pre></div>
</div>
</div>
<div class="section" id="mapping-the-osm-data-in-a-repository">
<h2>Mapping the OSM data in a repository<a class="headerlink" href="#mapping-the-osm-data-in-a-repository" title="Permalink to this headline">¶</a></h2>
<p>You can describe an entity to see how they are stored in the repository. For instance, let&#8217;s describe a way.</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig show way/24664831

ID:  7430790dde70a7f70c5ab7fc1f992d6a24afe8ab
FEATURE TYPE ID:  6deead5b94e28c813525d3371b26948bbf13c9ef

ATTRIBUTES
----------
visible: true
version: 4
timestamp: 1352568988000
tags: highway:unclassified
changeset: 13823696
user: KartoGrapHiti:57645
nodes: 268092812;268091938;268091940;268091942;268091944;268091946;268091948;268091950;2006749901;2006749897;2006749903;2006749899;2006749895;2006749893;2006749891;2006749889
way: LINESTRING (1.4914396 42.565715000000004, 1.4914782000000002 42.565614200000006, 1.4916327 42.5654625, 1.4919503 42.565228600000005, 1.4922250000000001 42.564982, 1.4924653 42.5647608, 1.4926455 42.5645838, 1.4929857000000002 42.5644574, 1.4931016000000001 42.564402400000006, 1.493273 42.564354900000005, 1.4936003 42.564430300000005, 1.493854 42.5643614, 1.4941412 42.5642499, 1.4942882000000002 42.5641138, 1.494936 42.563841700000005, 1.4951742000000001 42.5636925)
</pre></div>
</div>
<p>As you can see, all tags are stored together under a single attribute named <tt class="docutils literal"><span class="pre">tags</span></tt>. The structure of the attributes associated to an OSM way is fixed and always the same. You can, however, map your OSM data, creating a new tree in the repository with a different set of attributes derived from the tags. Mapping can also be used to filter the data, so only certain ways or nodes are stored in the new tree.</p>
<p>In the workshop dataset you will find a mapping file named <tt class="docutils literal"><span class="pre">mapping.json</span></tt>. Open it with a text editor. It should look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;rules&quot;</span><span class="p">:[</span>
  <span class="p">{</span>
    <span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;aerialways&quot;</span><span class="p">,</span>
    <span class="s">&quot;filter&quot;</span><span class="p">:{</span>
      <span class="s">&quot;aerialway&quot;</span><span class="p">:[]</span>
    <span class="p">},</span>
    <span class="s">&quot;fields&quot;</span><span class="p">:{</span>
      <span class="s">&quot;aerialway&quot;</span><span class="p">:{</span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;aerialway&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">:</span><span class="s">&quot;STRING&quot;</span><span class="p">},</span>
      <span class="s">&quot;name&quot;</span><span class="p">:{</span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">:</span><span class="s">&quot;STRING&quot;</span><span class="p">},</span>
      <span class="s">&quot;geom&quot;</span><span class="p">:{</span><span class="s">&quot;name&quot;</span><span class="p">:</span><span class="s">&quot;geom&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">:</span><span class="s">&quot;LINESTRING&quot;</span><span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>You can apply it to the repository by running</p>
<div class="highlight-python"><div class="highlight"><pre>geogig osm map mapping.json
</pre></div>
</div>
<p>Once applied, your tree should look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig ls
Root tree/
    node/
    aerialways/
    way/
</pre></div>
</div>
<p>Describing a single feature in the <tt class="docutils literal"><span class="pre">aerialways</span></tt> tree will show you the structure of the associated attributes, as defined in the mapping file.</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig show aerialways/52163704

ID:  4fe2996182dfcad8e440546f2a61d12291123e31
FEATURE TYPE ID:  0270c5fd961871135664733378fc6267881f53de

ATTRIBUTES
----------
id: 52163704
aerialway: chair_lift
name: TSD4 Portella
geom: LINESTRING (1.6132674 42.5535841, 1.6280712000000002 42.5526567)
nodes: 664559723;664559794
</pre></div>
</div>
<p>If you now want to do some editing of the aerial ways, it would be more practical to work on the recently created tree that contains them than directly with the tree containing all the ways and having the default schema.</p>
</div>
<div class="section" id="editing-the-osm-data">
<h2>Editing the OSM data<a class="headerlink" href="#editing-the-osm-data" title="Permalink to this headline">¶</a></h2>
<p>Editing is done outside the repository, so layer have to exported to a suitale format. Run the following command to export the <tt class="docutils literal"><span class="pre">aerialways</span></tt> folder to a shapefile</p>
<div class="highlight-python"><div class="highlight"><pre>$ shp export aerialways aerialways.shp
Exporting aerialways...
100%
aerialways exported successfully to aerialways.shp
</pre></div>
</div>
<p>You can now open the resulting shapefile in a software such as QGIS and edit it.</p>
<p>In the attributes table you will see that some features do not have a value in the <tt class="docutils literal"><span class="pre">name</span></tt> field. This is because the name tag was not found when mapping them. Locate the feature with the id 143323580 and enter a name in the name field. Save the changes to the shapefile.</p>
<p>Importing the shapefile back into the GeoGig repository will update it with the changes that you have done. To reimport it, use the following command:</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig shp import aerialways.shp
</pre></div>
</div>
<p>The changes can be inspected by using the diff command</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig diff HEAD WORK_HEAD
</pre></div>
</div>
<p>To get more detail about the change in the feture that we have modified use the following command:</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig diff HEAD WORK_HEAD -- aerialways/143323580
</pre></div>
</div>
<p>OSM operations work on the canonical representations of OSM features in the repo, which are always stored in the <tt class="docutils literal"><span class="pre">ways</span></tt> and <tt class="docutils literal"><span class="pre">nodes</span></tt> trees. Our changes are only stored in the <tt class="docutils literal"><span class="pre">aerialways</span></tt> tree, so we have to bring them to the canonical trees. This is done by unmapping the <tt class="docutils literal"><span class="pre">aerialways</span></tt> tree. To unmap it, we can use the following command</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig osm unmap
</pre></div>
</div>
<p>Now changes have also been applied to the <tt class="docutils literal"><span class="pre">ways</span></tt> tree, as it can be seen by running the following command:</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig diff HEAD WORK_HEAD -- ways
</pre></div>
</div>
<p>To create a new snapshot in the repository history, add and commit the above changes.</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig add
$ geogig commit -m &quot;Added missing airway name&quot;
</pre></div>
</div>
</div>
<div class="section" id="contributing-changes-back-to-the-osm-planet">
<h2>Contributing changes back to the OSM planet<a class="headerlink" href="#contributing-changes-back-to-the-osm-planet" title="Permalink to this headline">¶</a></h2>
<p>GeoGig can generate a file with the differences between two snapshots in a format suitable for being contributed to the OSM planet. In our case, we can export the change that we have just introduced and later apply in in the OSM planet. This is done using the following command.</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig osm create-changeset HEAD~1 HEAD
</pre></div>
</div>
<p>However, the resulting changeset will not have valid changeset ID assigned, since those IDs are managed by the OSM API. As a result of that, you will not be able to apply that chageset on the OSM planet. Changesets generated by the <tt class="docutils literal"><span class="pre">create-changeset</span></tt> command will be valid IDs only if they represent a change that is already part of the OSM planet, but not a change that has been manually added in the GeoGig repository.</p>
<p>To fix that, you first have to create an ID using the OSM API, sending a PUT request to <tt class="docutils literal"><span class="pre">http://api.openstreetmap.org/api/0.6/changeset/create</span></tt>. You can use curl on a terminal to do that. Check <a href="#id1"><span class="problematic" id="id2">``</span></a><a class="reference external" href="http://wiki.openstreetmap.org/wiki/API_v0">http://wiki.openstreetmap.org/wiki/API_v0</a>.6```for more information about this usage of the OSM API.</p>
<p>The PUT request will return the ID of the changeset, and you can provided it to the <tt class="docutils literal"><span class="pre">create-changeset</span></tt> GeoGig command, as follows.</p>
<div class="highlight-python"><div class="highlight"><pre>$ geogig geogig osm create-changeset HEAD~1 HEAD --id &lt;your_changeset_id&gt;
</pre></div>
</div>
<p>The resulting diff file can now be pushed to the OSM planet. GeoGig, however, does not implement that functionality, so you should curl or some other similar tool to do it.</p>
</div>
</div>


      <p class="centered-text"><a href="#top"><img src="_static/arrow_up.png" alt="back to top"/></a></p>
      </div><!-- /#content> -->
  <div id="sidebar" class="sidebar-offcanvas contrast col-sm-4 sidebar-offcanvas" id="sidebar" role="navigation">

    <div>
         <form id="quick-search" action="search.html" method="get" style="width: 100%;">
          <fieldset>
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <input id="quick-search-query" type="text" name="q" accessKey="q" name="searchQuery.queryString" size="25" value="Search Documentation&hellip;" size="20" tabindex="3" onblur="if(this.value=='') this.value='Search Documentation&hellip;';" onfocus="if(this.value=='Search Documentation&hellip;') this.value='';" />
          </fieldset>
        </form>


        <div class="btn-group-vertical" id="docs_toc"> 
          <button type="button" class="btn btn-default"><a href="/docs/">User Manual</a></button>
          <button type="button" class="btn btn-default"><a href="/technical/">Technical Manual</a></button>
          <button type="button" class="btn btn-default"><a href="/manpages/">Man Pages</a></button>
          <button type="button" class="btn btn-default"><a href="/workshop/">Workshop</a></button>
      </div>
      <h3 class="pngfix">Table Of Contents</h3>
        <ul>
<li><a class="reference internal" href="#">Working with OSM data in GeoGig</a><ul>
<li><a class="reference internal" href="#setting-up-the-osm-base">Setting up the OSM base.</a></li>
<li><a class="reference internal" href="#mapping-the-osm-data-in-a-repository">Mapping the OSM data in a repository</a></li>
<li><a class="reference internal" href="#editing-the-osm-data">Editing the OSM data</a></li>
<li><a class="reference internal" href="#contributing-changes-back-to-the-osm-planet">Contributing changes back to the OSM planet</a></li>
</ul>
</li>
</ul>

        <div class="section-footer"></div>
      </div>
        <div class="section">
        <h3>This Page</h3>
        <ul class="this-page-menu">
          <li><a href="_sources/osm_workshop.txt">Show Source</a></li>
        </ul>
        </div>
        <div class="section">
          <h3>License</h3>
          <p>This project is licensed under the <a href="https://github.com/locationtech/geogig/blob/master/LICENSE.txt">BSD New License</a>.</p>
        </div>

  </div><!-- /#sidebar -->
  </div><!-- /.wrap> -->
</div>
</div>

</div><!-- /#main -->
    <footer>
      <div class="container">
        <div class="row">
          <div class=""><p class="repo-owner"><a href="https://github.com/locationtech/geogig">GeoGig</a> is maintained by <a href="https://github.com/boundlessgeo"><img src="_static/Boundless_Logo.png" alt="Boundless"></a></p></div>
        </div>
      </div>
    </footer>


  <script type="text/javascript" src="_static/jquery.js"></script>
  <script type="text/javascript" src="_static/jquery-migrate-min.js"></script>
  <script type="text/javascript" src="_static/bootstrap.js" ></script>
  <script type="text/javascript" src="_static/underscore.js"></script>
  <script type="text/javascript" src="_static/doctools.js"></script>
  <script type="text/javascript" src="_static/searchtools.js"></script>
  <script type="text/javascript" src="searchindex.js"></script>
  <script>
      $(document).ready(function() {

      $('[data-toggle=offcanvas]').click(function(e) {
        e.stopPropagation();
        $('.row-offcanvas').toggleClass('active');
        $('.btn-back').toggleClass('active');
        $('.btn-text').toggleClass('active');
      });
      $('.list-group-item').click(function(e) {
        e.stopPropagation();
        $('.row-offcanvas').toggleClass('active');
        $('.btn-back').toggleClass('active');
        $('.btn-text').toggleClass('active');
      });
    });
  </script>
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-3879903-19']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
  </script>
  </body>
</html>
