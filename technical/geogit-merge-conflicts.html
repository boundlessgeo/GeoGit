<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, maximum-scale=1">
  
  <title>GeoGit merge conflicts strategy &mdash; GeoGit 0.10.0 Technical Manual</title>
  <link rel="stylesheet" href="_static/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="_static/print.css" type="text/css" media="print" /> 
  <!--[if IE]>
  <link rel="stylesheet" href="_static/blueprint/ie.css" type="text/css" media="screen, projection" />
  <![endif]-->
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/offcanvas.css" type="text/css" />
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.10.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html'
    };
  </script>
  <link rel="shortcut icon" href="_static/favicon.ico"/>
      <link rel="top" title="GeoGit 0.10.0 Technical Manual" href="index.html" />
      <link rel="next" title="Sparse clone" href="sparse-clone.html" />
      <link rel="prev" title="GeoGit for developers" href="developers.html" />
</head>
<body class="geogit-merge-conflicts">
    <div id="blacktop"></div>
    <header id="masthead">
      <div class="navbar">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://geogit.org"><h1>GeoGit</h1></a>
          </div>
          <div class="navbar-collapse collapse navbar-right">
            <ul class="nav navbar-nav">
              <li><a href="http://geogit.org/#install">Get Started</a></li>
              <li><a href="http://geogit.org/docs/index.html">Documentation</a></li>
              <li><a href="https://github.com/boundlessgeo/GeoGit">On Github</a></li>
            </ul>
          </div><!--/.navbar-collapse -->
        </div>
      </div>
    </header>

    <section class="subheading hidden-xs">
      <div class="container">
        <div class="row">
          <div class="col-md-8">
            <p class="byline">A Tool for Geospatial Data Management</p>
          </div>
        </div>
      </div>
    </section>
    <a name="top"></a>

 <div id="main">
    <div class="wrap selfclear">
      <div id="content">
      <div class="container">
        <div class="row row-offcanvas row-offcanvas-right">
          <div class="col-md-8"> 
            <div class="row pull-right">
             <div class="visible-sm visible-xs" id="menu-btn">
                <button class="btn btn-blue btn-sm"type="button" data-toggle="offcanvas">
                  <span class="btn-text active">Menu &rarr;</span>
                  <span class="btn-back">&larr; Back</span>
                </button>
              </div>
            </div>
<ul id="breadcrumbs">
  
  <li><a href="index.html">GeoGit 0.10.0 Technical Manual</a> &raquo;</li>
  <li>GeoGit merge conflicts strategy</li>
</ul>
<ul id="relatedlinks" class="selfclear">
  <li class="first">
    <a href="genindex.html" title="General Index"
       accesskey="I">index</a></li>
  <li>
    <a href="sparse-clone.html" title="Sparse clone"
       accesskey="N">next</a>|</li>
  <li>
    <a href="developers.html" title="GeoGit for developers"
       accesskey="P">previous</a>|</li>
</ul>
        
  <div class="section" id="geogit-merge-conflicts-strategy">
<h1>GeoGit merge conflicts strategy<a class="headerlink" href="#geogit-merge-conflicts-strategy" title="Permalink to this headline">¶</a></h1>
<p>This documents discusses how GeoGit behaves in the case of merge conflicts, and the different elements involved.</p>
<div class="section" id="possible-merge-scenarios">
<h2>Possible merge scenarios<a class="headerlink" href="#possible-merge-scenarios" title="Permalink to this headline">¶</a></h2>
<p>This is a comprehensive list of possible situations that are handled when merging changes from two actors.</p>
<p>Non-conflicting situations:</p>
<p>Both actors have added the same feature type
Both actors have added the same feature
Both actors have modified the same feature attribute of a feature, setting the same new value
Both actors have removed the same feature
Both actor have removed the same feature type
Both actor have modified a feature, each of them modifying different attributes, so there is no overlap in changes
Both actor have modified a feature geometry, each of them altering a different part of it, so changes are compatible (for instance, in a multipolygon geometry, each one has edited a different polygon, or in a single-line one, one actor has moved the starting point while the other has moved the ending point.</p>
<p>Conflicting changes</p>
<p>Actors have modified the same attribute in a feature, setting different new values.
Actors have edited the geometry of a feature, making incompatible changes (for instance, one of them has added deleted a subgeometry, while the other has deleted it). User should select one of the changes, or the union of resulting geometries, if possible.
One actor has modified a feature or feature type, while the other has deleted it.
One actor has modified a feature attribute, while the other has deleted it.
Both actors have added a feature or feature type with the same name, but different content. User should select which feature to keep, or not to add any of them. This should consider features added under the path for that feature type, to correctly set the corresponding metadata ID for features.</p>
<p>Conflict-solving strategy</p>
<p>The three basic parts of the strategy followed by GeoGit are the conflicts file (to flag conflicted files and store versions to merge), the working tree (to edit the conflicts and solve them) and the references (to keep track of merged branches while the conflicts are being solved and then committed). They are explained next.</p>
</div>
<div class="section" id="the-conflict-file-during-a-conflicted-merge-operation">
<h2>The conflict file during a conflicted merge operation<a class="headerlink" href="#the-conflict-file-during-a-conflicted-merge-operation" title="Permalink to this headline">¶</a></h2>
<p>Unlike git, GeoGit does not put conflict marks in the index, but in a <tt class="docutils literal"><span class="pre">conflict</span></tt> file in the <tt class="docutils literal"><span class="pre">geogit</span></tt> repository. This text file contains triplets of IDs in each line, with the following structure:</p>
<p>&lt;ancestor_ID&gt; t &lt;ours_ID&gt; t and &lt;theirs_ID&gt;</p>
<p>IDs refer to features in the case of a conflicted feature, and to featureTypes in the case of a conflict in a tree (not the tree ID)</p>
<p>Ours is equivalent to the HEAD version, while theirs is the MERGE_HEAD version (this references are discussed later)</p>
</div>
<div class="section" id="the-working-tree-file-during-a-conflicted-merge-operation">
<h2>The working tree file during a conflicted merge operation<a class="headerlink" href="#the-working-tree-file-during-a-conflicted-merge-operation" title="Permalink to this headline">¶</a></h2>
<p>In Git, the working tree version contains the result of the &#8220;merge&#8221; program with conflict markers (&lt;&lt;&lt; === &gt;&gt;&gt;). Git alters the working tree version so the merge tool, which is not a Git tool, can access all the changes from both parts without having to be able to read the index. The application doesn’t have to be aware of Git at any point, but just handle text files and understand the syntax of the merge program.</p>
<p>This behaviour cannot be copied in GeoGit, since a version with all changes together cannot be stored with the design of the working tree. Instead, the working tree features will remain unchanged, and should be changed by the merge tool when resolving the conflict. The 3 versions needed for a 3-way merge are all stored in the  repository database, and can be accessed using the IDs referenced in the conflicts file.</p>
</div>
<div class="section" id="references-during-a-conflicted-merge-operation">
<h2>References during a conflicted merge operation.<a class="headerlink" href="#references-during-a-conflicted-merge-operation" title="Permalink to this headline">¶</a></h2>
<p>When a merge operation cannot be completed because of existing conflicts, GeoGit creates a MERGE_HEAD reference that  points to the branch to merge. It also keeps a ORIG_HEAD reference, which points to the head of the branch onto which the merge is to be performed. GeoGit actually doesn’t use this as a flag to see if there are conflicts (they can be removed and it will still complain when performing a commit).</p>
<p>The conflicted stated is just kept on the conflicts file. MERGE_HEAD is, however, used when performing the commit. If removed, once the conflict is solved, the commit can be performed, but will have just HEAD as the parent commit, like a normal commit.</p>
<p>ORIG_HEAD is useful for aborting the merge operation by doing, for instance, <tt class="docutils literal"><span class="pre">geogit</span> <span class="pre">reset</span> <span class="pre">--hard</span> <span class="pre">ORIG_HEAD</span></tt></p>
<p>The resulting commit will have as parents both ORIG_HEAD and the MERGE_HEAD.</p>
<p>GeoGit keeps a MERGE_MSG file, that will be used by the commit operation, and its generated by Git automatically, containing the names of conflicted files</p>
</div>
<div class="section" id="some-implementation-details">
<h2>Some implementation details<a class="headerlink" href="#some-implementation-details" title="Permalink to this headline">¶</a></h2>
<p>The StagingArea class is responsible of marking conflicts as solved when an element is added, so classes staging to the index do not have to take care of that. It also resolve conflicts when the STAGE_HEAD reference is updated</p>
<p>The heap-based staging database has also a heap-based conflicts storage.</p>
<p>An AOP scheme has been implemented to intercept calls to the &#8216;call&#8217; method of operations that cannot run while a merge conflict is being solved. Operations in the &#8216;plumbing&#8217; package, and those annotated with the &#64;CanRunDuringConflict annotation, are not intercepted. The remaining ones are intercepted and aborted if conflicts exist.</p>
<p>This approach should not collide with the method interception used by the hooks functionality, although certain operations might be intercepted by both of them. It should be reviewed once both branches are merged, to ensure the interceptor corresponding to the merge conflict has priority</p>
<p>The available  merge strategies are as follows:</p>
<ul class="simple">
<li>normal merge with conflicts marking if merging two branches.</li>
<li>octopus merge if merging more than two branches. Operation is canceled if conflicts exist</li>
<li>&#8220;ours&#8221; and &#8220;theirs&#8221; strategies available if explicitly invoked, only for the case of merging just two branches</li>
</ul>
</div>
<div class="section" id="mergetool">
<h2>MergeTool<a class="headerlink" href="#mergetool" title="Permalink to this headline">¶</a></h2>
<p>Although still unfinished, the above functionality can be used to discuss, implement and test a tool for solving merge conflicts.</p>
<p>Currently, a <tt class="docutils literal"><span class="pre">conflicts</span></tt> commands is implemented, which returns a description of all conflicts, or just those that match a given path, if it is specified. It basically calls the &#8216;cat&#8217; command on the ancestor, ours and theirs versions of each conflict, and prints that out. This could be used by an external mergetool.</p>
</div>
<div class="section" id="import-of-solved-elements">
<h2>Import of solved elements<a class="headerlink" href="#import-of-solved-elements" title="Permalink to this headline">¶</a></h2>
<p>If external merge tools are planned, there should be a way for them to import solved elements in the working tree. Currently, the only way of importing is from shp/PostGIS/Spatialite, but that might not be the best solution in this case. A simpler way, like importing from a text string, should be implemeted in GeoGit. Normal users will not use those method to import their data, but tools needing to alter the working tree could use them and it would be much easier to implement a working connection between them and GeoGit.</p>
</div>
<div class="section" id="tree-feature-type-changes">
<h2>Tree/Feature type changes<a class="headerlink" href="#tree-feature-type-changes" title="Permalink to this headline">¶</a></h2>
<p>The current implementation support merging branches where features have been altered. If changes have affected feature types, this requires a different handling, which is rather different to the case of git.</p>
<p>This different approach is not only related to how conflicts are evaluated and merged, but also how differences are reported by operations like DiffTree. Some changes might not actually affect an object in the repo, but just the node pointing to it. This should be handled differently.</p>
<p>In the current implementation, the merge operation is capable of detecting conflicting changes in the default metadata associated to a tree, marking the tree as conflicted, even if no change has been done to its content. The conflict is stored in the index by storing the ancestor, ‘ours’ and ‘theirs’ metadata id’s, instead of the element id, which might remain unchanged (if no change to the nodes in the tree has been made), or not.</p>
<p>When a conflicted entry in the index resolves to a tree, it stores the medatata id’s, but not tree id’s. This is not needed, since the modification causing a conflict has to be a modification in the associated feature type, not in the features it contains.</p>
<p>How to solve this kind of conflict that appears due to different metadata and not due to different features, should be discussed and taken into account when designing the mergetool.</p>
</div>
</div>


      <div class="selfclear pagination-nav">
          <div class="leftwise"><strong>Previous</strong>: <a href="developers.html" title="previous chapter">GeoGit for developers</a></div>
          <div class="rightwise"><strong>Next</strong>: <a href="sparse-clone.html" title="next chapter">Sparse clone</a></div>
      </div>
      <p class="centered-text"><a href="#top"><img src="_static/arrow_up.png" alt="back to top"/></a></p>
      </div><!-- /#content> -->
  <div id="sidebar" class="sidebar-offcanvas contrast col-sm-4 sidebar-offcanvas" id="sidebar" role="navigation">

    <div>
         <form id="quick-search" action="search.html" method="get" style="width: 100%;">
          <fieldset>
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <input id="quick-search-query" type="text" name="q" accessKey="q" name="searchQuery.queryString" size="25" value="Search Documentation&hellip;" size="20" tabindex="3" onblur="if(this.value=='') this.value='Search Documentation&hellip;';" onfocus="if(this.value=='Search Documentation&hellip;') this.value='';" />
          </fieldset>
        </form>


        <div class="btn-group-vertical" id="docs_toc"> 
          <button type="button" class="btn btn-default"><a href="/docs/">User Manual</a></button>
          <button type="button" class="btn btn-default"><a href="/technical/">Technical Manual</a></button>
          <button type="button" class="btn btn-default"><a href="/manpages/">Man Pages</a></button>
          <button type="button" class="btn btn-default"><a href="/workshop/">Workshop</a></button>
      </div>
      <h3 class="pngfix">Table Of Contents</h3>
        <ul>
<li><a class="reference internal" href="#">GeoGit merge conflicts strategy</a><ul>
<li><a class="reference internal" href="#possible-merge-scenarios">Possible merge scenarios</a></li>
<li><a class="reference internal" href="#the-conflict-file-during-a-conflicted-merge-operation">The conflict file during a conflicted merge operation</a></li>
<li><a class="reference internal" href="#the-working-tree-file-during-a-conflicted-merge-operation">The working tree file during a conflicted merge operation</a></li>
<li><a class="reference internal" href="#references-during-a-conflicted-merge-operation">References during a conflicted merge operation.</a></li>
<li><a class="reference internal" href="#some-implementation-details">Some implementation details</a></li>
<li><a class="reference internal" href="#mergetool">MergeTool</a></li>
<li><a class="reference internal" href="#import-of-solved-elements">Import of solved elements</a></li>
<li><a class="reference internal" href="#tree-feature-type-changes">Tree/Feature type changes</a></li>
</ul>
</li>
</ul>

        <div class="section-footer"></div>
      </div>
        <div class="section continue_reading">
          <h3>Continue Reading</h3>
          <ul>
            <li>Previous: <a href="developers.html" title="previous chapter">GeoGit for developers</a></li>
            <li>Next: <a href="sparse-clone.html" title="next chapter">Sparse clone</a></li>
          </ul>
        </div>
        <div class="section">
        <h3>This Page</h3>
        <ul class="this-page-menu">
          <li><a href="_sources/geogit-merge-conflicts.txt">Show Source</a></li>
        </ul>
        </div>
        <div class="section">
          <h3>License</h3>
          <p>This project is licensed under the <a href="https://github.com/boundlessgeo/GeoGit/blob/master/LICENSE.txt">BSD New License</a>, except for the GeoServer plugin which is available under the <a href="http://geoserver.org/display/GEOS/License">GPL 2.0 License</a>.</p>
        </div>

  </div><!-- /#sidebar -->
  </div><!-- /.wrap> -->
</div>
</div>

</div><!-- /#main -->
    <footer>
      <div class="container">
        <div class="row">
          <div class=""><p class="repo-owner"><a href="https://github.com/boundlessgeo/GeoGit">GeoGit</a> is maintained by <a href="https://github.com/boundlessgeo"><img src="_static/Boundless_Logo.png" alt="Boundless"></a></p></div>
        </div>
      </div>
    </footer>


  <script type="text/javascript" src="_static/jquery.js"></script>
  <script type="text/javascript" src="_static/jquery-migrate-min.js"></script>
  <script type="text/javascript" src="_static/bootstrap.js" ></script>
  <script type="text/javascript" src="_static/underscore.js"></script>
  <script type="text/javascript" src="_static/doctools.js"></script>
  <script type="text/javascript" src="_static/searchtools.js"></script>
  <script type="text/javascript" src="searchindex.js"></script>
  <script>
      $(document).ready(function() {

      $('[data-toggle=offcanvas]').click(function(e) {
        e.stopPropagation();
        $('.row-offcanvas').toggleClass('active');
        $('.btn-back').toggleClass('active');
        $('.btn-text').toggleClass('active');
      });
      $('.list-group-item').click(function(e) {
        e.stopPropagation();
        $('.row-offcanvas').toggleClass('active');
        $('.btn-back').toggleClass('active');
        $('.btn-text').toggleClass('active');
      });
    });
  </script>
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-3879903-19']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
  </script>
  </body>
</html>
